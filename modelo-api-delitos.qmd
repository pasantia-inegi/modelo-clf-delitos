---
# title: "Modelo y API predicci칩n de delitos"
# author: "Enero 2024"
format:
  revealjs:
    auto-stretch: false
    margin: 0
    slide-number: true
    scrollable: true
    preview-links: auto
    page-layout: custom
    logo: imagenes/logo_portada2.png
    css: ine_quarto_styles.css
    # footer: <https://quarto.org>
engine: knitr
---

#

<!---
# TODO: this does not work
 .linea-superior[]
.linea-inferior[] 
--->

<!---
# TODO: this does not work
 ![](imagenes/logo_portada2.png){.center style="width: 20%;"}   
--->

[]{.linea-superior} 
[]{.linea-inferior} 


<!---
 <img src="imagenes/logo_portada2.png" style="width: 20%"/>  
--->

[<img src="imagenes/logo_portada2.png" width="20%"/> ]{.center-justified}


[**Proyecto Ciencia de Datos**]{.big-par .center-justified}
[**Modelo y API predicci칩n de delitos**]{.big-par .center-justified}
[**Encuesta Nacional Urbana de Seguridad Ciudadana**]{.medium-par .center-justified}

[**Enero 2024**]{.big-par .center-justified}


## Contenidos

1. Descripci칩n del modelo 游댍
    - [Contexto]{.big-par}
    - [M칠tricas]{.big-par} 
2. 쯈u칠 es una API?
3. API modelo delitos
4. Uso de API en el browser
5. Uso program치tico de la API 游눹九꽲잺
    - [쮺칩mo realizamos predicciones?]{.big-par}
    - [쮺칩mo extraemos los datos de entrenamiento y testeo?]{.big-par}



## Descripci칩n del modelo | Contexto (1/2)

::: {.incremental}

- Para la creaci칩n del modelo de clasificaci칩n, se utilizaron los 15 tipos de delitos disponibles con una separaci칩n train-test del 80%-20%.

- Se ajust칩 un modelo con redes neuronales usando una capa de embeddings y LSTM.

- Dada la existencia de relatos cortos no informativos tales como:
    
    [*sin relato, julio 2019,  error al contestar, ocurrido en octubre, <br>
     denunci칩 a fiscalia en junio de este a침o, no paso a mayores, etc*]{style="color:gray;" .center}
  
  se decidi칩 crear un **segundo modelo experimental con 16 clases**; 15 delitos disponibles m치s la clase  [*SIN_CLASIFICACION*]{style="color:blue;"}.

:::

## Descripci칩n del modelo | Contexto (2/2)


::: {.pull-left  .medium-par}

- **Modelo de 15 clases**: 33462 observaciones de entrenamiento y 8357 observaciones de testeo.

- **Modelo de 16 clases**: 33637 observaciones de entrenamiento y 8401 observaciones de testeo.

:::

. . . 

::: { .medium-par .pull-right}

```{r metricas, echo = FALSE, warning=FALSE, message=FALSE}

library(readr)
library(dplyr)
library(kableExtra)
library(readxl)

metricas_test_mod15clas <- read_excel("data/metricas_modelo_15clases_V4.xlsx")
metricas_test_mod16clas <- read_excel("data/metricas_modelo_16clases_V3.xlsx")
load('data/tabla_n_del.RData')

tabla %>% 
  kbl()

```

:::


## Descripci칩n del modelo | M칠tricas

::: { .medium-par .pull-left}

M칠tricas modelo con **15 clases** en set de testeo:

- Accuracy = `r round(metricas_test_mod15clas$support[16], digits = 3)`

::: { .small-par}

```{r m_mod15, echo = FALSE}

metricas_test_mod15clas %>% 
  mutate( precision= round(precision, digits = 3),
          recall= round(recall, digits = 3),
          `f1-score` = round(`f1-score`, digits = 3), 
          obs= round(support)) %>% 
  head(15) %>%
  kbl()


```

:::

$$ $$

:::

. . .

::: {.medium-par .pull-right}

M칠tricas modelo con **16 clases** en set de testeo: 

- Accuracy = `r round(metricas_test_mod16clas$support[17], digits = 3)`

::: { .small-par}

```{r m_mod16, echo =FALSE}

metricas_test_mod16clas %>% 
  mutate( precision= round(precision, digits = 3),
          recall= round(recall, digits = 3),
          `f1-score` = round(`f1-score`, digits = 3), 
          obs= round(support)) %>% 
  head(16) %>% 
  kbl()
```

:::

$$ $$

:::


## 쯈u칠 es una API?


::: {.incremental}
- Las APIs (_Application Programming Interface_) son piezas de c칩digo que permiten que dos aplicaciones o computadoras se comuniquen.

- Se podr칤a decir que la API es un intermediario que permite a que un programa le pida cosas espec칤ficas a otro programa, sin necesidad 
de conocer en detalle c칩mo funciona este otro.


- En la pr치ctica, nos permiten acceder desde un programa en nuestro computador -como Python o R- a los datos de alg칰n servicio, al que de otra manera no tendr칤amos acceso o bien tendr칤amos que hacerlo pasando por la p치gina web, lo que implica un proceso m치s costoso para el usuario y para el proveedor.

- Ejemplos cl치sicos de APIs son: API de twitter para recolectar tuits, iniciar sesi칩n con Google, API de la CMF para valor UF, monedas extranjeras, IPC, etc.
:::

## 쯈u칠 es una API?

::::{.columns}

:::{.column style='flex: 0.45' .medium-par} 
La analog칤a del restaurant es pr치ctica para entender la l칩gica de las API:

- El usuario/a ser칤a el cliente
- La API ser칤a la mesera
- La informaci칩n que nos puede disponibilizar la API es el men칰
- Los servidores con sus bases de datos ser칤an la cocina

:::


:::{.column style='flex: 0.45' .medium-par} 
Por lo tanto:

- El usuario le pide a la API una informaci칩n espec칤fica (el plato) en base a lo disponible 
en el men칰. Luego, los servidores/cocina se encargan de obtener esa informaci칩n desde las
bases de datos y finalmente la API le entrega el plato/informaci칩n al usuario, si es que este es
parte del men칰.
:::

::::

[<img src="imagenes/api_restaurant.webp" width="60%" />]{.center}


## 쯈u칠 es una API?

<img src="imagenes/rest-api.jpg" width="100%" style="float: right;" />




## Uso y motivaci칩n

:::{.incremental .medium-par}
- La API del INE da acceso directo a las tablas publicadas por el INE, evit치ndole a sus usuarios pasar
por la p치gina web, adem치s de entregar informaci칩n como nombres de las columnas e
informaci칩n descriptiva de las tablas.
  - Actualmente se encuentran disponibles EPF, ENUSC, ESI y ENE
  
- La idea de su creaci칩n es facilitar el acceso a datos a usuarios m치s avanzados, que conocen este tipo de herramientas.

- El paquete, adem치s, permite acceder a la API en un formato m치s familiar, que sea c칩modo para usuarios y usuarias de nivel intermedio
:::

## La API inedata

:::{.incremental .medium-par}

- La API est치 compuesta por 4 _endpoints_ principales
  - Un _endpoint_ es una ruta dentro de la API que tiene asignada una tarea espec칤fica
  
- Estos son:
  - `/data`: Se ingresa `.json` que contiene la encuesta y versi칩n y opcionalmente una lista de columnas. Si no se ingresa lista de columnas devuelve tabla con todas sus columnas, caso contrario se filtran columnas. Esta se devuelve en formato `.json`
    - `.json` es una forma est치ndar y flexible de dar formato y estructura a los datos, facilitando su transmisi칩n
:::


:::: {.r-stack}
::: {.fragment .fade-in-then-out }
Uso:

  <p align="center">
  
::::{.columns}

:::{.column style='flex: 0.3' } 
  <img src="imagenes/get_data_curl.png" style="width:100%; margin-right:20px;"  />
:::

:::{.column style='flex: 0.3' } 
  <img src="imagenes/get_data_python.png"style="width:100%; margin-right:20px;" />
:::

:::{.column style='flex: 0.3' } 
  <img src="imagenes/get_data_r.png"style="width:100%; margin-right:20px;" />
:::

::::
</p>
:::

::: {.fragment .fade-in-then-out }
Resultado:

<img src="imagenes/output_get_data.png" width="65%" />

:::    

::::
## La API inedata


::: {.medium-par}
- La API est치 compuesta por 4 _endpoints_ principales
  - Un _endpoint_ es una ruta dentro de la API que tiene asignada una tarea espec칤fica
  
- Estos son:

  - `/colnames`: se le entrega un dataset y una versi칩n y a cambio entrega las columnas de esa tabla.


:::


::: {.fragment}
Uso:

     http://127.0.0.1:8000/colnames?dataset=epf_gastos&version=viii


:::

::: {.fragment}
Resultado:

     {"data":["index","칦췉쯐ONA","FOLIO_V","FOLIO","FE","VARSTRAT","VARUNIT","CCIF","D","G","C","SC","P","GASTO","GLOSA"]}


:::
    

## La API inedata


::: {.medium-par}
- La API est치 compuesta por 4 _endpoints_ principales
  - Un _endpoint_ es una ruta dentro de la API que tiene asignada una tarea espec칤fica
  
- Estos son:

  - `/info`: entrega informaci칩n descriptiva de las tablas disponibles. Opcionalmente se puede ingresar una encuesta para filtrar, obteniendo la informaci칩n de las tablas asociadas a esa encuesta


:::

::: {.fragment}
Uso:

     http://127.0.0.1:8000/info?dataset_filter=epf_gastos


:::

::: {.fragment}
Resultado:

     "[{\"survey\":\"epf_gastos\",\"version\":\"vii\",\"n_row\":641938,\"n_col\":12,\"file_size\":32763938},{\"survey\":\"epf_gastos\",\"version\":\"viii\",\"n_row\":1064239,\"n_col\":15,\"file_size\":85938002}]"


:::
   

## La API inedata


::: {.medium-par}
- La API est치 compuesta por 4 _endpoints_ principales
  - Un _endpoint_ es una ruta dentro de la API que tiene asignada una tarea espec칤fica
  
- Estos son:

  - `/uploadfile`: permite subir tablas nuevas, que podr치n ser consultadas en un futuro.
    - Solo para administradores de la API.
    - Es posible que este _endpoint_ cambie considerablemente.


:::

::: {.fragment}
UI al ingresar al endpoint:

<img src="imagenes/uploadfile.png" style="width:60%; margin-right:20px;" />

:::

## API en acci칩n

Al entrar a la URL, se nos env칤a directamente a la documentaci칩n, que, junto con explicar cada _endpoint_
nos permite probarlos.

Probemos la api!




## [Uso program치tico de la API | 쮺칩mo realizamos predicciones?]{.big-par}

Conexi칩n desde R:

```{r eval = FALSE, echo=TRUE}

# cargar paquetes 
library(httr)
library(jsonlite)

# ingresar la url API
url <- 'http://10.90.2.47:3123/docs'

# indicar tipo de modelo: 'modelo_15_clases' o 'modelo_16_clases':
query <- list(tipo_modelo = "modelo_15_clases")     

# indicar relatos a clasificar:
body <- list("Iba hablando por telefono y me arrancaron el celular de las manos", 
             'ingresaron a mi casa rompuedo la chapa, me amenazaron y robaron joyas')

# realizar el requerimiento:
respuesta <- POST(url,                              # url API
                  path = '/predecir',               # ruta, NO MODIFICAR
                  body = body,                      # relatos a clasificar
                  query = query,                    # modelo 
                  encode = "json")

# desenvolvemos las predicciones anidadas JSON de la lista a R
prediccion <- fromJSON(content(respuesta, 'text', encoding = 'UTF-8'))

# revisamos la variable
str(prediccion)

# transformando de caracter a numerico
prediccion$probabilidades <- apply(prediccion$probabilidades, 2, as.numeric) %>%
  as.data.frame()

# extraemos la probabilidad maxima alcanzada:

prediccion$probabilidades <- prediccion$probabilidades %>% 
  mutate(prob_max = apply(prediccion$probabilidades, 1, max, na.rm=TRUE))

```



## [Uso program치tico de la API | 쮺칩mo extraemos los datos train-test?]{.big-par}

Para obtener los datos de entrenamiento y testeo, es necesario que los usuarios tengan una cuenta con acceso al endopoint, pues se utiliza un sistema de autenticaci칩n mediante *tokens*, el cual posee una duraci칩n limitada.

. . .

Conexi칩n desde R:

:::{.medium-par}
- Obteniendo token$^*$:

```{r eval = FALSE, echo=TRUE}

# Ingresando informaci칩n del usuario con variables de ambiente:
usuario <- list(username =  Sys.getenv("USERNAME"), 
                password = Sys.getenv("PASSWORD"))
                
# Realizar requerimiento para obtener el token de acceso del usuario:
resp_token <- POST(url = 'http://10.90.2.47:3123/token', 
                   body = usuario,
                   authenticate(usuario$username, usuario$password))     

# Extraer respuesta y token:
token <- content(resp_token)
token <- paste(token$token_type, token$access_token)

```

- Obteniendo datos de entrenamiento y testeo:

```{r eval = FALSE, echo=TRUE}

respuesta <- GET(url,                         
                 path = '/get_training_data', 
                 query = query,                          # modelo_15_clases / modelo_16_clases
                 add_headers('Authorization' = token))              


## desenvolvemos los datos tipos JSON a R
data <- fromJSON(content(respuesta, 'text', encoding = "UTF-8"))

## volvemos a transformar los datos anidados JSON de la lista a R
y_test <- fromJSON(data$y_test)
X_test <- fromJSON(data$X_test)

```

:::

$^*$ [Para editar nuestras variables de ambiente del archivo *.Renviron*, podemos hacerlo usando la funci칩n `usethis::edit_r_environ()`, la cual nos abrir치 un archivo *.Renviron*. Una vez realizadas las modificaciones, reiniciamos la sesi칩n de R para observar los cambios.]{.small-par}

## 쮺onclusiones?

:::{.incremental }

- Prepararaci칩n para apertura al p칰blico (seguridad, conversaciones con SDTI)
- Ampliar el n칰mero de productos disponibles
- Incluir datos de series de tiempo de indicadores econ칩micos (desempleo, IPC, etc)
- Reformar el m칠todo de subida de datos nuevos  y su autentificaci칩n
- Replicar el paquete dataine en Python

:::



#

[]{.linea-superior} 
[]{.linea-inferior} 

<img src="imagenes/logo_portada2.png" width="20%"/>  



[**Proyecto Ciencia de Datos**]{.big-par .center-justified}
[**Modelo y API predicci칩n de delitos**]{.big-par .center-justified}
[**Encuesta Nacional Urbana de Seguridad Ciudadana**]{.medium-par .center-justified}

[**Enero 2024**]{.big-par .center-justified}

